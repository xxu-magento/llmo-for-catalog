compare_catalog_vs_webpage_task:
  description: >
    INPUTS:
    - pdp_url (string): {pdp_url}

    TASK:
    Perform a two-source comparison for the PDP URL.

    Steps (must follow in order):
    1) Call tool `commerce_pdp_scraper` with {"url": pdp_url}.
       - Parse the tool output as JSON.
       - Extract `normalized_sku`.
    2) Call tool `commerce_product_data_by_sku` with {"sku": normalized_sku}.
       - Parse the tool output as JSON.
    3) Compare fields across the two sources:
       - Treat webpage output as LIMITED (what is visible/embedded on the page).
       - Treat backend output as COMPREHENSIVE and source-of-truth when conflicts exist.
    4) Produce a structured comparison report.

    OUTPUT RULES (mandatory):
    - Output MUST be valid JSON.
    - Output MUST contain ONLY the keys specified in EXPECTED_OUTPUT.
    - Do NOT wrap output in markdown or code fences.
  expected_output: >
    {
      "pdp_url": "string",
      "sku": "string",
      "webpage_product": "object",
      "commerce_product": "object",
      "matches": [
        {
          "field": "string",
          "webpage_value": "any",
          "backend_value": "any",
          "notes": "string"
        }
      ],
      "mismatches": [
        {
          "field": "string",
          "webpage_value": "any",
          "backend_value": "any",
          "impact": "string"
        }
      ],
      "missing_on_webpage": [
        {
          "field": "string",
          "backend_value": "any",
          "why_important": "string"
        }
      ],
      "missing_in_backend": [
        {
          "field": "string",
          "webpage_value": "any",
          "why_important": "string"
        }
      ],
      "summary": {
        "top_issues": ["string"],
        "recommended_focus": ["string"]
      }
    }
  agent: catalog_comparison_agent

product_facts_enrichment_task:
  description: >
    INPUTS:
    - JSON output of `compare_catalog_vs_webpage_task` in context.

    TASK:
    Propose factual product enrichment derived from Commerce backend data that is missing
    or weak on the webpage.

    HARD CONSTRAINTS:
    - Do NOT invent facts. Only propose facts supported by backend data or explicitly
      indicated by the comparison output.
    - Output MUST be valid JSON.
    - Output MUST have EXACTLY two top-level keys:
      1) "suggested_changes"
      2) "explanations"
    - Do NOT include any other top-level keys.
    - Do NOT wrap output in markdown or code fences.

    OUTPUT CONTENT RULES:
    - suggested_changes must be key-value pairs, using keys under namespaces:
      - facts.attributes.<name>
      - facts.variants.summary
      - facts.facets.category_path
      - pdp.feature_bullets (optional: to surface backend facts on page)
      - pdp.description_plain (optional, factual additions only)
    - explanations must repeat the same keys, each mapping to:
      { why, source, evidence, implementation_notes }
    - source must be "commerce_backend" for factual additions.
  expected_output: >
    {
      "suggested_changes": {
        "facts.attributes.<name>": "any",
        "facts.variants.summary": ["string"],
        "facts.facets.category_path": ["string"],
        "pdp.feature_bullets": ["string"],
        "pdp.description_plain": "string"
      },
      "explanations": {
        "facts.attributes.<name>": {
          "why": "string",
          "source": "commerce_backend",
          "evidence": {
            "webpage_value": "any or null",
            "backend_value": "any"
          },
          "implementation_notes": "string"
        }
      }
    }
  agent: product_facts_enrichment_agent

shopper_intent_enrichment_task:
  description: >
    INPUTS:
    - JSON output of `compare_catalog_vs_webpage_task` in context (webpage + backend context).

    TASK:
    Propose structured shopper-intent enrichment fields.

    HARD CONSTRAINTS:
    - Output MUST be valid JSON.
    - Output MUST have EXACTLY two top-level keys:
      1) "suggested_changes"
      2) "explanations"
    - Do NOT include any other top-level keys.
    - Do NOT wrap output in markdown or code fences.
    - Only output structured intent fields; do not write SEO copy.

    REQUIRED KEYS:
    - intent.use_context: array of strings
    - intent.target_personas: array of strings

    SAFETY / CONSISTENCY:
    - Keep suggestions plausible and consistent with product/page context.
    - Do not introduce unverifiable claims (materials/certifications) unless backed by backend.
  expected_output: >
    {
      "suggested_changes": {
        "intent.use_context": ["string"],
        "intent.target_personas": ["string"]
      },
      "explanations": {
        "intent.use_context": {
          "why": "string",
          "source": "inferred",
          "evidence": {
            "webpage_value": "any or null",
            "backend_value": "any or null"
          },
          "implementation_notes": "string"
        },
        "intent.target_personas": {
          "why": "string",
          "source": "inferred",
          "evidence": {
            "webpage_value": "any or null",
            "backend_value": "any or null"
          },
          "implementation_notes": "string"
        }
      }
    }
  agent: shopper_intent_enrichment_agent

seo_visible_content_optimization_task:
  description: >
    INPUTS:
    - JSON output of `compare_catalog_vs_webpage_task` in context.
      Use webpage_product.seo fields if present:
      - seo.title_tag
      - seo.meta_description
      - seo.h1
      - seo.canonical (optional)
      - seo.robots (optional)
      - seo.page_lang (optional)
      Use webpage content (pdp_description_plain/html) for language/tone alignment.

    TASK:
    Propose SEO-friendly improvements to:
    - seo.title_tag
    - seo.meta_description
    - seo.h1
    Optionally propose:
    - pdp.title (if aligning on-page title is recommended)

    HARD CONSTRAINTS:
    - Output MUST be valid JSON.
    - Output MUST have EXACTLY two top-level keys:
      1) "suggested_changes"
      2) "explanations"
    - Do NOT include any other top-level keys.
    - Do NOT wrap output in markdown or code fences.
    - Match the language of the page content.
    - Avoid keyword stuffing; keep phrasing natural and human-written.
    - Keep title/meta/h1 distinct (not near-duplicates).
    - Preserve detected title formatting pattern if present (brand prefix/suffix).

    LENGTH RULES (mandatory; do NOT mention in rationales):
    - seo.title_tag: 30–65 chars
    - seo.h1: 10–70 chars
    - seo.meta_description: 100–160 chars
  expected_output: >
    {
      "suggested_changes": {
        "seo.title_tag": "string",
        "seo.meta_description": "string",
        "seo.h1": "string",
        "pdp.title": "string"
      },
      "explanations": {
        "seo.title_tag": {
          "why": "string",
          "source": "webpage",
          "evidence": {
            "webpage_value": "any or null",
            "backend_value": "any or null"
          },
          "implementation_notes": "string"
        },
        "seo.meta_description": {
          "why": "string",
          "source": "webpage",
          "evidence": {
            "webpage_value": "any or null",
            "backend_value": "any or null"
          },
          "implementation_notes": "string"
        },
        "seo.h1": {
          "why": "string",
          "source": "webpage",
          "evidence": {
            "webpage_value": "any or null",
            "backend_value": "any or null"
          },
          "implementation_notes": "string"
        }
      }
    }
  agent: seo_visible_content_optimization_agent

synthesize_final_change_plan_task:
  description: >
    INPUTS:
    - JSON output of `compare_catalog_vs_webpage_task`
    - JSON output of `product_facts_enrichment_task`
    - JSON output of `shopper_intent_enrichment_task`
    - JSON output of `seo_visible_content_optimization_task`

    TASK:
    Merge and reconcile suggested changes into one final plan.

    MERGE / CONFLICT RESOLUTION RULES (deterministic):
    1) For keys starting with "seo.": prefer seo_visible_content_optimization_task.
    2) For keys starting with "facts.": prefer product_facts_enrichment_task.
    3) For keys starting with "intent.": prefer shopper_intent_enrichment_task.
    4) For keys starting with "pdp." that appear in multiple sources:
       - choose the value that is factually consistent with backend AND most coherent
         with chosen seo.title_tag/meta_description/h1.
    5) Do not include any fields that contradict backend facts.

    OUTPUT RULES:
    - Output MUST be valid JSON.
    - Output MUST contain ONLY the keys specified in EXPECTED_OUTPUT.
    - Do NOT wrap output in markdown or code fences.

    VALIDATION RULE:
    - Set validation.schema_ok=true only if your output matches EXPECTED_OUTPUT exactly:
      top-level keys and required nested keys exist with correct types.
expected_output: >
  {
    "final_suggested_changes": {
      "string_key": "any_json_value"
    },
    "final_explanations": {
      "string_key": {
        "why": "string",
        "sources": ["string"],
        "evidence": {
          "webpage_value": "any_json_value_or_null",
          "backend_value": "any_json_value_or_null"
        },
        "implementation_notes": "string"
      }
    },
    "conflicts_resolved": [
      {
        "field": "string",
        "candidates": [
          {"from": "string", "value": "any_json_value"}
        ],
        "chosen": {"from": "string", "value": "any_json_value"},
        "rationale": "string"
      }
    ],
    "validation": {
      "schema_ok": true,
      "notes": "string"
    }
  }
  agent: change_synthesizer_agent